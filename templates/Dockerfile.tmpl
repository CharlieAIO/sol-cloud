FROM ubuntu:22.04

RUN apt-get update && apt-get install -y wget curl ca-certificates bash nginx bzip2 && rm -rf /var/lib/apt/lists/*

# Install Agave CLI for x86_64 (Fly runs linux/amd64 for this project).
ENV SOLANA_VERSION=2.3.13
ENV PATH="/usr/local/bin:$PATH"
RUN wget -q https://github.com/anza-xyz/agave/releases/download/v${SOLANA_VERSION}/solana-release-x86_64-unknown-linux-gnu.tar.bz2 && \
    tar -xjf solana-release-x86_64-unknown-linux-gnu.tar.bz2 && \
    cp -r solana-release/bin/* /usr/local/bin/ && \
    rm -rf solana-release solana-release-x86_64-unknown-linux-gnu.tar.bz2 && \
    solana --version

RUN mkdir -p /var/lib/solana/ledger

COPY nginx.conf /etc/nginx/nginx.conf
COPY entrypoint.sh /usr/local/bin/start-solana.sh
COPY program /opt/sol-cloud/program
RUN chmod +x /usr/local/bin/start-solana.sh

EXPOSE 8080

CMD ["/usr/local/bin/start-solana.sh"]
