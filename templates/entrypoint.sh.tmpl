#!/usr/bin/env bash
set -euo pipefail

SLOTS_PER_EPOCH="{{ .Validator.SlotsPerEpoch }}"
CLOCK_MULTIPLIER="{{ .Validator.ClockMultiplier }}"
COMPUTE_UNIT_LIMIT="{{ .Validator.ComputeUnitLimit }}"

supports_flag() {
  local flag="$1"
  solana-test-validator --help 2>&1 | grep -q -- "$flag"
}

ticks_per_slot=64
if [ "$CLOCK_MULTIPLIER" -gt 1 ]; then
  ticks_per_slot=$((64 / CLOCK_MULTIPLIER))
  if [ "$ticks_per_slot" -lt 1 ]; then
    ticks_per_slot=1
  fi
fi

args=(
  --ledger /var/lib/solana/ledger
  --bind-address 0.0.0.0
  --reset
  --url https://api.mainnet-beta.solana.com
  --limit-ledger-size 10000
  --slots-per-epoch "$SLOTS_PER_EPOCH"
)

if supports_flag --ticks-per-slot; then
  args+=(--ticks-per-slot "$ticks_per_slot")
fi

if supports_flag --compute-unit-limit; then
  args+=(--compute-unit-limit "$COMPUTE_UNIT_LIMIT")
else
  echo "warning: this solana-test-validator build does not support --compute-unit-limit; continuing without it" >&2
fi

solana-test-validator "${args[@]}" &
validator_pid=$!

nginx -g 'daemon off;' &
nginx_pid=$!

cleanup() {
  kill "$validator_pid" "$nginx_pid" 2>/dev/null || true
}

trap cleanup INT TERM EXIT

wait -n "$validator_pid" "$nginx_pid"
exit_code=$?
cleanup
wait "$validator_pid" "$nginx_pid" 2>/dev/null || true
exit "$exit_code"
